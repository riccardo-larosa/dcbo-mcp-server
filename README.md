# Docebo MCP OAuth2 Proxy Server

Multi-tenant MCP (Model Context Protocol) server that acts as an OAuth2 authorization server proxy for Docebo. Similar to `mcp.zapier.com`, this server enables MCP clients to discover and authenticate with multiple Docebo tenants through a single endpoint.

## Features

- **OAuth2 Proxy**: Acts as authorization server, proxying to Docebo tenants
- **Multi-Tenant**: Support multiple Docebo tenants with separate credentials
- **RFC Compliant**: Implements RFC 8414 (Authorization Server Metadata) and RFC 9728 (Protected Resource Metadata)
- **Automatic Discovery**: MCP clients auto-discover OAuth2 endpoints
- **Stateless**: No session storage, all state in OAuth parameters
- **MCP Protocol**: Latest version 2025-03-26

## Architecture

```
MCP Client (Claude, ChatGPT, etc.)
    ↓
    ↓ 1. Discovery: GET /.well-known/oauth-authorization-server
    ↓
mcp.docebosaas.com (This Server)
    ↓ Returns: authorization_endpoint, token_endpoint
    ↓
    ↓ 2. OAuth Flow: GET /oauth2/authorize?tenant=riccardo-lr-test
    ↓ Server encodes tenant in state parameter
    ↓ Redirects to:
    ↓
riccardo-lr-test.docebosaas.com/oauth2/authorize
    ↓
    ↓ 3. User authorizes, callback with code + state
    ↓
    ↓ 4. Token Exchange: POST /oauth2/token (with code + state)
    ↓ Server decodes tenant from state
    ↓ Injects tenant credentials
    ↓ Proxies to:
    ↓
riccardo-lr-test.docebosaas.com/oauth2/token
    ↓ Returns access_token
    ↓
    ↓ 5. MCP Call: POST /mcp?tenant=riccardo-lr-test
    ↓ With: Authorization: Bearer <token>
    ↓ Server calls:
    ↓
riccardo-lr-test.docebosaas.com/manage/v1/*
    ↓ Returns data to client
```

## Prerequisites

- Node.js 22.x or later
- Docebo LMS instance(s) with OAuth2 apps configured
- OAuth2 client credentials for each tenant
- (Optional) ngrok for local testing

## Installation

```bash
npm install
```

## Configuration

### 1. Server Configuration

Copy the example environment file:

```bash
cp .env.example .env
```

Edit `.env`:

```env
# Server public URL (use ngrok URL for local testing)
SERVER_PUBLIC_URL=https://mcp.docebosaas.com
# Or for local testing:
# SERVER_PUBLIC_URL=https://abc123.ngrok.io

PORT=3000
ALLOWED_ORIGINS=*
ALLOW_LOCAL_DEV=true
```

### 2. Tenant Configuration

Add credentials for each Docebo tenant:

```env
# Format: TENANT_{UPPERCASE_TENANT_ID}_CLIENT_ID
#         TENANT_{UPPERCASE_TENANT_ID}_CLIENT_SECRET

# Example: Tenant "riccardo-lr-test"
TENANT_RICCARDO_LR_TEST_CLIENT_ID=my-mcp-server
TENANT_RICCARDO_LR_TEST_CLIENT_SECRET=abc123secret...

# Example: Tenant "acme-corp"
TENANT_ACME_CORP_CLIENT_ID=acme-oauth-app
TENANT_ACME_CORP_CLIENT_SECRET=xyz789secret...
```

**Note**: Tenant ID format conversion:
- URL format: `riccardo-lr-test`
- Env var format: `RICCARDO_LR_TEST`
- Server automatically converts between formats

### 3. Docebo OAuth2 App Setup

For each tenant, create an OAuth2 app in Docebo:

1. Log in to Docebo tenant admin
2. Go to **Admin Menu** → **API & SSO** → **API Credentials**
3. Click **Add OAuth2 App**
4. Configure:
   - **Client ID**: Choose a name (e.g., "mcp-server")
   - **Client Secret**: Auto-generated by Docebo
   - **Grant Types**: Select "Authorization Code" and "Refresh Token"
   - **Redirect URL**: `https://mcp.docebosaas.com/callback` (or your public URL)
   - **Scopes**: `api`
5. Save and copy the Client ID and Client Secret
6. Add to `.env` file using format above

## Development

### Local Development with ngrok

1. Start ngrok tunnel:
   ```bash
   ngrok http 3000
   ```

2. Update `.env` with ngrok URL:
   ```env
   SERVER_PUBLIC_URL=https://abc123.ngrok.io
   ```

3. Start dev server:
   ```bash
   npm run dev
   ```

4. Server will be available at:
   - `https://abc123.ngrok.io` (public)
   - `http://localhost:3000` (local)

### MCP Client Configuration

Configure MCP client (e.g., Claude Desktop) to point to your server:

```json
{
  "mcpServers": {
    "docebo-riccardo": {
      "url": "https://abc123.ngrok.io/mcp?tenant=riccardo-lr-test",
      "transport": "streamable-http"
    }
  }
}
```

**Key points**:
- Include `?tenant=<tenant-id>` in the URL
- MCP client will auto-discover OAuth2 endpoints
- Client will handle full OAuth2 flow automatically

## API Endpoints

### Discovery Endpoints

#### `GET /.well-known/oauth-authorization-server` (RFC 8414)

Returns OAuth2 authorization server metadata:

```json
{
  "issuer": "https://mcp.docebosaas.com",
  "authorization_endpoint": "https://mcp.docebosaas.com/oauth2/authorize",
  "token_endpoint": "https://mcp.docebosaas.com/oauth2/token",
  "scopes_supported": ["api"],
  "response_types_supported": ["code"],
  "grant_types_supported": ["authorization_code", "refresh_token", "password"],
  "code_challenge_methods_supported": ["S256"]
}
```

#### `GET /.well-known/oauth-protected-resource` (RFC 9728)

Returns protected resource metadata:

```json
{
  "resource": "https://mcp.docebosaas.com",
  "authorization_servers": ["https://mcp.docebosaas.com"],
  "bearer_methods_supported": ["header"]
}
```

### OAuth2 Endpoints

#### `GET /oauth2/authorize?tenant=<tenant-id>&...`

Proxies OAuth2 authorization request to Docebo tenant.

**Required parameters**:
- `tenant`: Docebo tenant ID (e.g., `riccardo-lr-test`)
- Standard OAuth2 parameters: `client_id`, `response_type`, `redirect_uri`, `scope`, `state`, `code_challenge`, etc.

**Flow**:
1. Server encodes tenant into state parameter
2. Redirects to `https://{tenant}.docebosaas.com/oauth2/authorize`
3. User authorizes in Docebo
4. Docebo redirects back with `code` and encoded `state`

#### `POST /oauth2/token`

Proxies OAuth2 token request to Docebo tenant.

**Supported grant types**:
- `authorization_code`: Requires `state` parameter with tenant info
- `refresh_token`: Requires `?tenant=<id>` query parameter
- `password`: Requires `?tenant=<id>` query parameter

**Flow**:
1. Server extracts tenant from state or query
2. Injects tenant's client_id and client_secret
3. Proxies to `https://{tenant}.docebosaas.com/oauth2/token`
4. Returns token response to client

### MCP Endpoint

#### `POST /mcp?tenant=<tenant-id>`

MCP JSON-RPC endpoint.

**Headers**:
- `Authorization: Bearer <access_token>`
- `Content-Type: application/json`

**Example request**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "docebo.list_users",
    "arguments": {
      "page_size": 10
    }
  }
}
```

## MCP Tools

### `docebo.list_users`

List users from Docebo LMS.

**Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | number | Page number (1-indexed) |
| `page_size` | number | Users per page (default: 200, max: 200) |
| `sort_attr` | string | Sort attribute (e.g., "user_id", "username") |
| `sort_dir` | string | Sort direction: "asc" or "desc" |
| `search_text` | string | Search filter for username or email |

## Testing

### Test Discovery Endpoint

```bash
curl https://abc123.ngrok.io/.well-known/oauth-authorization-server | jq .
```

### Test OAuth2 Flow (Manual)

1. **Start authorization**:
   ```
   https://abc123.ngrok.io/oauth2/authorize?tenant=riccardo-lr-test&client_id=test&response_type=code&redirect_uri=http://localhost:3000/callback&scope=api
   ```

2. **Exchange code for token** (after authorization):
   ```bash
   curl -X POST https://abc123.ngrok.io/oauth2/token \
     -d "grant_type=authorization_code" \
     -d "code=<authorization_code>" \
     -d "redirect_uri=http://localhost:3000/callback" \
     -d "state=<state_from_callback>"
   ```

3. **Call MCP endpoint**:
   ```bash
   TOKEN="<access_token_from_step_2>"

   curl -X POST "https://abc123.ngrok.io/mcp?tenant=riccardo-lr-test" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "jsonrpc": "2.0",
       "id": 1,
       "method": "tools/call",
       "params": {
         "name": "docebo.list_users",
         "arguments": {"page_size": 5}
       }
     }'
   ```

## Production Deployment

### Environment Variables

```env
SERVER_PUBLIC_URL=https://mcp.docebosaas.com
PORT=3000
ALLOWED_ORIGINS=*
ALLOW_LOCAL_DEV=false

# Add all tenant credentials
TENANT_<ID>_CLIENT_ID=...
TENANT_<ID>_CLIENT_SECRET=...
```

### Build and Run

```bash
npm run build
npm start
```

### Deployment Checklist

- [ ] Set `ALLOW_LOCAL_DEV=false`
- [ ] Use HTTPS (required for OAuth2)
- [ ] Configure all tenant credentials
- [ ] Set correct `SERVER_PUBLIC_URL`
- [ ] Update OAuth2 app redirect URIs in Docebo
- [ ] Monitor logs for errors
- [ ] Test with MCP client

## Security

- **No Client Secrets Exposed**: Tenant credentials stored server-side only
- **HTTPS Required**: OAuth2 requires secure connections
- **State Parameter**: Prevents CSRF attacks
- **PKCE Support**: Enhanced security for public clients (S256)
- **Bearer Tokens**: Validated by Docebo on each API call
- **No Session Storage**: Stateless architecture

## Troubleshooting

### "Tenant not configured" error

- Check tenant ID format in environment variables
- Ensure `TENANT_{UPPERCASE}_CLIENT_ID` and `_CLIENT_SECRET` are set
- Restart server after adding new tenants

### "Invalid credentials" from Docebo

- Verify client_id and client_secret are correct
- Check OAuth2 app is active in Docebo
- Ensure grant types are enabled in Docebo app

### OAuth redirect issues

- Verify `SERVER_PUBLIC_URL` is correct
- Check redirect URI matches in Docebo OAuth2 app
- For ngrok, update URL after tunnel restart

### CORS errors

- Set `ALLOWED_ORIGINS=*` for testing
- Check `ALLOW_LOCAL_DEV=true` for local development

## Architecture Details

### Multi-Tenant Credential Storage

Credentials are stored in environment variables with naming convention:

```
TENANT_{TENANT_ID_UPPERCASE_WITH_UNDERSCORES}_CLIENT_ID
TENANT_{TENANT_ID_UPPERCASE_WITH_UNDERSCORES}_CLIENT_SECRET
```

Conversion examples:
- `riccardo-lr-test` → `TENANT_RICCARDO_LR_TEST_CLIENT_ID`
- `acme-corp` → `TENANT_ACME_CORP_CLIENT_ID`
- `test-123` → `TENANT_TEST_123_CLIENT_ID`

### State Parameter Encoding

The server encodes tenant information in the OAuth2 `state` parameter:

```typescript
{
  tenant: "riccardo-lr-test",
  original: "<client_original_state>"
}
```

Encoded as base64url JSON. This allows the server to:
1. Route token requests to correct tenant
2. Inject correct credentials
3. Preserve client's original state

### File Structure

```
src/
├── config.ts          # Server configuration
├── tenants.ts         # Multi-tenant credential management
├── oauth-proxy.ts     # OAuth2 authorize & token proxy
├── server.ts          # Express app with all endpoints
├── mcp.ts             # MCP JSON-RPC handler
└── docebo.ts          # Docebo API client
```

## Future Enhancements

See [ENHANCEMENTS.md](ENHANCEMENTS.md) for planned improvements:

- Tenant validation before proxying
- Dynamic tenant registration via admin API
- OAuth2 token caching
- Rate limiting
- Enhanced monitoring and logging

## License

MIT

## Support

For issues and questions, please file a GitHub issue.
