# Docebo MCP OAuth2 Proxy Server

Multi-tenant MCP (Model Context Protocol) server that acts as an OAuth2 authorization server proxy for Docebo. Similar to `mcp.zapier.com`, this server enables MCP clients to discover and authenticate with multiple Docebo tenants through a single endpoint.

## Features

- **OAuth2 Proxy**: Acts as authorization server, proxying to Docebo tenants
- **Multi-Tenant**: Support multiple Docebo tenants with separate credentials
- **RFC Compliant**: Implements RFC 8414 (Authorization Server Metadata) and RFC 9728 (Protected Resource Metadata)
- **Automatic Discovery**: MCP clients auto-discover OAuth2 endpoints
- **Stateless**: No session storage, all state in OAuth parameters
- **MCP Protocol**: Latest version 2025-03-26

## Architecture

```
MCP Client (Claude, ChatGPT, MCP Inspector, etc.)
    ↓
    ↓ 1. Discovery: GET /mcp/riccardo-lr-test/.well-known/oauth-authorization-server
    ↓
mcp.docebosaas.com (This Server)
    ↓ Returns: tenant-specific endpoints
    ↓   authorization_endpoint: /mcp/riccardo-lr-test/oauth2/authorize
    ↓   token_endpoint: /mcp/riccardo-lr-test/oauth2/token
    ↓
    ↓ 2. OAuth Flow: GET /mcp/riccardo-lr-test/oauth2/authorize
    ↓ Server extracts tenant from URL path
    ↓ Redirects to:
    ↓
riccardo-lr-test.docebosaas.com/oauth2/authorize
    ↓
    ↓ 3. User authorizes, callback with code
    ↓
    ↓ 4. Token Exchange: POST /mcp/riccardo-lr-test/oauth2/token
    ↓ Server extracts tenant from URL path
    ↓ Overrides redirect_uri with tenant's configured value
    ↓ Injects tenant credentials (client_id, client_secret)
    ↓ Proxies to:
    ↓
riccardo-lr-test.docebosaas.com/oauth2/token
    ↓ Returns access_token
    ↓
    ↓ 5. MCP Call: POST /mcp/riccardo-lr-test
    ↓ With: Authorization: Bearer <token>
    ↓ Server calls:
    ↓
riccardo-lr-test.docebosaas.com/manage/v1/*
    ↓ Returns data to client
```

## Prerequisites

- Node.js 22.x or later
- Docebo LMS instance(s) with OAuth2 apps configured
- OAuth2 client credentials for each tenant
- (Optional) ngrok for local testing

## Installation

```bash
npm install
```

## Configuration

### 1. Server Configuration

Copy the example environment file:

```bash
cp .env.example .env
```

Edit `.env`:

```env
# Server public URL (use ngrok URL for local testing)
SERVER_PUBLIC_URL=https://mcp.docebosaas.com
# Or for local testing:
# SERVER_PUBLIC_URL=https://abc123.ngrok.io

PORT=3000
ALLOWED_ORIGINS=*
ALLOW_LOCAL_DEV=true
```

### 2. Tenant Configuration

Add credentials for each Docebo tenant:

```env
# Format: TENANT_{UPPERCASE_TENANT_ID}_CLIENT_ID
#         TENANT_{UPPERCASE_TENANT_ID}_CLIENT_SECRET
#         TENANT_{UPPERCASE_TENANT_ID}_REDIRECT_URI

# Example: Tenant "riccardo-lr-test"
TENANT_RICCARDO_LR_TEST_CLIENT_ID=my-mcp-server
TENANT_RICCARDO_LR_TEST_CLIENT_SECRET=abc123secret...
TENANT_RICCARDO_LR_TEST_REDIRECT_URI=https://mcp.docebosaas.com/oauth/callback

# Example: Tenant "acme-corp"
TENANT_ACME_CORP_CLIENT_ID=acme-oauth-app
TENANT_ACME_CORP_CLIENT_SECRET=xyz789secret...
TENANT_ACME_CORP_REDIRECT_URI=https://mcp.docebosaas.com/oauth/callback
```

**Important**: The `REDIRECT_URI` must match what is registered in the Docebo OAuth2 app. The server will override the client's redirect_uri with this value during token exchange to ensure compatibility with MCP clients.

**Note**: Tenant ID format conversion:
- URL format: `riccardo-lr-test`
- Env var format: `RICCARDO_LR_TEST`
- Server automatically converts between formats

### 3. Docebo OAuth2 App Setup

For each tenant, create an OAuth2 app in Docebo:

1. Log in to Docebo tenant admin
2. Go to **Admin Menu** → **API & SSO** → **API Credentials**
3. Click **Add OAuth2 App**
4. Configure:
   - **Client ID**: Choose a name (e.g., "mcp-server")
   - **Client Secret**: Auto-generated by Docebo
   - **Grant Types**: Select "Authorization Code" and "Refresh Token"
   - **Redirect URL**: `https://mcp.docebosaas.com/callback` (or your public URL)
   - **Scopes**: `api`
5. Save and copy the Client ID and Client Secret
6. Add to `.env` file using format above

## Development

### Local Development with ngrok

1. Start ngrok tunnel:
   ```bash
   ngrok http 3000
   ```

2. Update `.env` with ngrok URL:
   ```env
   SERVER_PUBLIC_URL=https://abc123.ngrok.io
   ```

3. Start dev server:
   ```bash
   npm run dev
   ```

4. Server will be available at:
   - `https://abc123.ngrok.io` (public)
   - `http://localhost:3000` (local)

### MCP Client Configuration

Configure MCP client (e.g., MCP Inspector) to point to your server's tenant-specific endpoint:

```bash
# MCP Inspector
npx @modelcontextprotocol/inspector \
  --transport http \
  --server-url https://abc123.ngrok.io/mcp/riccardo-lr-test
```

**Key points**:
- **Tenant in URL path**: `/mcp/<tenant-id>` (NOT query string)
- MCP client will auto-discover OAuth2 endpoints from `/mcp/<tenant-id>/.well-known/oauth-authorization-server`
- Client will handle full OAuth2 flow automatically
- Each tenant has its own isolated MCP endpoint

**Note**: Claude Desktop currently only supports stdio transport (not HTTP), so it cannot connect to this server yet. Use MCP Inspector for testing.

## API Endpoints

All endpoints are tenant-specific and include the tenant ID in the URL path.

### Discovery Endpoints

#### `GET /mcp/<tenant-id>/.well-known/oauth-authorization-server` (RFC 8414)

Returns OAuth2 authorization server metadata for a specific tenant:

```json
{
  "issuer": "https://mcp.docebosaas.com/mcp/riccardo-lr-test",
  "authorization_endpoint": "https://mcp.docebosaas.com/mcp/riccardo-lr-test/oauth2/authorize",
  "token_endpoint": "https://mcp.docebosaas.com/mcp/riccardo-lr-test/oauth2/token",
  "scopes_supported": ["api"],
  "response_types_supported": ["code"],
  "grant_types_supported": ["authorization_code", "refresh_token", "password"],
  "code_challenge_methods_supported": ["S256"]
}
```

#### `GET /mcp/<tenant-id>/.well-known/oauth-protected-resource` (RFC 9728)

Returns protected resource metadata for a specific tenant:

```json
{
  "resource": "https://mcp.docebosaas.com/mcp/riccardo-lr-test",
  "authorization_servers": ["https://mcp.docebosaas.com/mcp/riccardo-lr-test"]
}
```

### OAuth2 Endpoints

#### `GET /mcp/<tenant-id>/oauth2/authorize`

Proxies OAuth2 authorization request to Docebo tenant.

**Parameters**:
- Standard OAuth2 parameters: `client_id`, `response_type`, `redirect_uri`, `scope`, `state`, `code_challenge`, etc.
- Tenant ID is extracted from URL path (NOT query string)

**Flow**:
1. Server extracts tenant from URL path
2. Redirects to `https://{tenant}.docebosaas.com/oauth2/authorize`
3. User authorizes in Docebo
4. Docebo redirects back with authorization `code`

#### `POST /mcp/<tenant-id>/oauth2/token`

Proxies OAuth2 token request to Docebo tenant.

**Body parameters** (application/x-www-form-urlencoded):
- `grant_type`: `authorization_code`, `refresh_token`, or `password`
- `code`: Authorization code (for `authorization_code` grant)
- `redirect_uri`: Client's redirect URI (server overrides with tenant's configured value)
- `code_verifier`: PKCE verifier (optional)
- Other grant-specific parameters

**Flow**:
1. Server extracts tenant from URL path
2. Overrides `redirect_uri` with tenant's configured value
3. Injects tenant's `client_id` and `client_secret`
4. Proxies to `https://{tenant}.docebosaas.com/oauth2/token`
5. Returns token response to client

**Important**: The server automatically overrides the `redirect_uri` parameter with the tenant's configured `REDIRECT_URI` to ensure it matches what's registered in Docebo.

### MCP Endpoint

#### `POST /mcp/<tenant-id>`

MCP JSON-RPC endpoint for a specific tenant.

**Headers**:
- `Authorization: Bearer <access_token>`
- `Content-Type: application/json`

**Example request**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "docebo.list_users",
    "arguments": {
      "page_size": 10
    }
  }
}
```

## MCP Tools

### `docebo.list_users`

List users from Docebo LMS.

**Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | number | Page number (1-indexed) |
| `page_size` | number | Users per page (default: 200, max: 200) |
| `sort_attr` | string | Sort attribute (e.g., "user_id", "username") |
| `sort_dir` | string | Sort direction: "asc" or "desc" |
| `search_text` | string | Search filter for username or email |

## Testing

### Test Discovery Endpoint

```bash
curl https://abc123.ngrok.io/.well-known/oauth-authorization-server | jq .
```

### Test OAuth2 Flow (Manual)

1. **Test discovery endpoint**:
   ```bash
   curl https://abc123.ngrok.io/mcp/riccardo-lr-test/.well-known/oauth-authorization-server | jq .
   ```

2. **Start authorization** (paste this URL in browser):
   ```
   https://abc123.ngrok.io/mcp/riccardo-lr-test/oauth2/authorize?client_id=test&response_type=code&redirect_uri=https://abc123.ngrok.io/oauth/callback&scope=api&code_challenge=CHALLENGE&code_challenge_method=S256
   ```

3. **Exchange code for token** (after authorization):
   ```bash
   curl -X POST https://abc123.ngrok.io/mcp/riccardo-lr-test/oauth2/token \
     -H 'Content-Type: application/x-www-form-urlencoded' \
     -d "grant_type=authorization_code" \
     -d "code=<authorization_code>" \
     -d "code_verifier=<verifier>" \
     -d "redirect_uri=https://abc123.ngrok.io/oauth/callback"
   ```

4. **Call MCP endpoint**:
   ```bash
   TOKEN="<access_token_from_step_3>"

   curl -X POST "https://abc123.ngrok.io/mcp/riccardo-lr-test" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "jsonrpc": "2.0",
       "id": 1,
       "method": "tools/call",
       "params": {
         "name": "docebo.list_users",
         "arguments": {"page_size": 5}
       }
     }'
   ```

## Production Deployment

### Environment Variables

```env
SERVER_PUBLIC_URL=https://mcp.docebosaas.com
PORT=3000
ALLOWED_ORIGINS=*
ALLOW_LOCAL_DEV=false

# Add all tenant credentials
TENANT_<ID>_CLIENT_ID=...
TENANT_<ID>_CLIENT_SECRET=...
```

### Build and Run

```bash
npm run build
npm start
```

### Deployment Checklist

- [ ] Set `ALLOW_LOCAL_DEV=false`
- [ ] Use HTTPS (required for OAuth2)
- [ ] Configure all tenant credentials
- [ ] Set correct `SERVER_PUBLIC_URL`
- [ ] Update OAuth2 app redirect URIs in Docebo
- [ ] Monitor logs for errors
- [ ] Test with MCP client

## Security

- **No Client Secrets Exposed**: Tenant credentials stored server-side only
- **HTTPS Required**: OAuth2 requires secure connections
- **State Parameter**: Prevents CSRF attacks
- **PKCE Support**: Enhanced security for public clients (S256)
- **Bearer Tokens**: Validated by Docebo on each API call
- **No Session Storage**: Stateless architecture

## Troubleshooting

### "Tenant not configured" error

- Check tenant ID format in environment variables
- Ensure `TENANT_{UPPERCASE}_CLIENT_ID` and `_CLIENT_SECRET` are set
- Restart server after adding new tenants

### "Invalid credentials" from Docebo

- Verify client_id and client_secret are correct
- Check OAuth2 app is active in Docebo
- Ensure grant types are enabled in Docebo app

### OAuth redirect issues

- Verify `SERVER_PUBLIC_URL` is correct
- Check redirect URI matches in Docebo OAuth2 app
- For ngrok, update URL after tunnel restart

### CORS errors

- Set `ALLOWED_ORIGINS=*` for testing
- Check `ALLOW_LOCAL_DEV=true` for local development

## Architecture Details

### Multi-Tenant Credential Storage

Credentials are stored in environment variables with naming convention:

```
TENANT_{TENANT_ID_UPPERCASE_WITH_UNDERSCORES}_CLIENT_ID
TENANT_{TENANT_ID_UPPERCASE_WITH_UNDERSCORES}_CLIENT_SECRET
TENANT_{TENANT_ID_UPPERCASE_WITH_UNDERSCORES}_REDIRECT_URI
```

Conversion examples:
- `riccardo-lr-test` → `TENANT_RICCARDO_LR_TEST_CLIENT_ID`
- `acme-corp` → `TENANT_ACME_CORP_CLIENT_ID`
- `test-123` → `TENANT_TEST_123_CLIENT_ID`

**Important**: Each tenant must have all three values configured:
1. `CLIENT_ID` - OAuth2 client ID from Docebo
2. `CLIENT_SECRET` - OAuth2 client secret from Docebo
3. `REDIRECT_URI` - The redirect URI registered in Docebo OAuth2 app

The `REDIRECT_URI` is automatically injected during token exchange, overriding whatever the MCP client sends. This ensures compatibility with MCP clients that may send different redirect URIs (e.g., MCP Inspector sends `http://localhost:6274/oauth/callback/debug`).

### Tenant Detection from URL Path

The server extracts the tenant ID from the URL path for all endpoints:

- `/mcp/<tenant-id>` → Tenant ID extracted from path
- `/mcp/<tenant-id>/oauth2/authorize` → Tenant ID extracted from path
- `/mcp/<tenant-id>/oauth2/token` → Tenant ID extracted from path

No query string parameters required. The tenant is added to `req.body.tenant` before passing to the OAuth proxy, which then:
1. Loads tenant configuration
2. Injects tenant credentials
3. Overrides redirect_uri with tenant's configured value
4. Proxies request to Docebo

### File Structure

```
src/
├── config.ts          # Server configuration
├── tenants.ts         # Multi-tenant credential management
├── oauth-proxy.ts     # OAuth2 authorize & token proxy
├── server.ts          # Express app with all endpoints
├── mcp.ts             # MCP JSON-RPC handler
└── docebo.ts          # Docebo API client
```

## Future Enhancements

See [ENHANCEMENTS.md](ENHANCEMENTS.md) for planned improvements:

- Tenant validation before proxying
- Dynamic tenant registration via admin API
- OAuth2 token caching
- Rate limiting
- Enhanced monitoring and logging

## License

MIT

## Support

For issues and questions, please file a GitHub issue.
