# Docebo MCP Server

Minimal MCP (Model Context Protocol) server that exposes Docebo LMS API through a secure JSON-RPC interface.

## Features

- **Client-Side OAuth2**: MCP clients handle OAuth2 authentication with Docebo
- **Stateless Server**: No credentials stored on server, accepts client Bearer tokens
- **Secure API**: Origin validation for production security
- **Streamable HTTP Transport**: JSON-RPC over HTTP/HTTPS
- **Single Tool**: `docebo.list_users` - List and search Docebo users

## Prerequisites

- Node.js 22.x or later
- Docebo LMS instance with API access
- OAuth2 app configured in Docebo (for client authentication)

## Installation

```bash
npm install
```

## Server Configuration

1. Copy the example environment file:

```bash
cp .env.example .env
```

2. Configure the server:

```env
DOCEBO_BASE_URL=https://your-tenant.docebosaas.com
PORT=3000
ALLOWED_ORIGINS=https://chat.openai.com,https://claude.ai

# For local development with MCP Inspector
ALLOW_LOCAL_DEV=true
```

**Note**: The server is stateless and doesn't store any credentials. OAuth2 authentication is handled by MCP clients.

## Client Configuration

MCP clients (like Claude Desktop, ChatGPT, or custom clients) must be configured to handle OAuth2 authentication with Docebo.

### OAuth2 Discovery

The MCP server implements **RFC 9728 (OAuth 2.0 Protected Resource Metadata)** for automatic OAuth2 discovery. MCP clients can discover the authorization server by fetching:

```
https://your-server.com/.well-known/oauth-authorization-server
```

This returns:
```json
{
  "issuer": "https://your-tenant.docebosaas.com",
  "authorization_endpoint": "https://your-tenant.docebosaas.com/oauth2/authorize",
  "token_endpoint": "https://your-tenant.docebosaas.com/oauth2/token",
  "scopes_supported": ["api"],
  "response_types_supported": ["code"],
  "grant_types_supported": ["authorization_code", "password", "refresh_token"],
  "code_challenge_methods_supported": ["S256"]
}
```

### Example: Claude Desktop Configuration

If your MCP client supports automatic discovery, you can simply configure:

```json
{
  "mcpServers": {
    "docebo": {
      "url": "https://your-server.com/mcp",
      "transport": "streamable-http"
    }
  }
}
```

Or configure OAuth2 explicitly:

```json
{
  "mcpServers": {
    "docebo": {
      "url": "https://your-server.com/mcp",
      "transport": "streamable-http",
      "oauth": {
        "authorizationUrl": "https://your-tenant.docebosaas.com/oauth2/authorize",
        "tokenUrl": "https://your-tenant.docebosaas.com/oauth2/token",
        "clientId": "your-docebo-oauth-client-id",
        "clientSecret": "your-docebo-oauth-client-secret",
        "scopes": ["api"]
      }
    }
  }
}
```

### Docebo OAuth2 Setup

1. In Docebo, go to **Admin Menu** → **API & SSO** → **API Credentials**
2. Click **Add OAuth2 App**
3. Configure:
   - **Client ID**: Create a unique name (e.g., "mcp-client")
   - **Grant Types**: Check "Authorization Code" and "Password"
   - **Redirect URL**: For Authorization Code flow, add your client's callback URL
4. Note the **Client Secret** generated by Docebo
5. Use these credentials in your MCP client configuration

## Development

Start the server in watch mode:

```bash
npm run dev
```

### Using with MCP Inspector

The [MCP Inspector](https://github.com/modelcontextprotocol/inspector) is a tool for testing MCP servers locally. To use it with this server:

1. Enable local dev mode in your `.env`:
   ```env
   ALLOW_LOCAL_DEV=true
   ```

2. Get an OAuth2 token from Docebo:
   ```bash
   curl -X POST "https://your-tenant.docebosaas.com/oauth2/token" \
     -d "grant_type=password" \
     -d "client_id=your_oauth_client_id" \
     -d "client_secret=your_oauth_client_secret" \
     -d "username=admin" \
     -d "password=your_password" \
     -d "scope=api"
   ```

3. Start the server:
   ```bash
   npm run dev
   ```

4. Run the MCP Inspector:
   ```bash
   npx @modelcontextprotocol/inspector streamable-http http://localhost:3000/mcp
   ```

5. In the Inspector UI, add the Bearer token:
   - Header: `Authorization`
   - Value: `Bearer <access_token_from_step_2>`

**Important**: Always set `ALLOW_LOCAL_DEV=false` in production! This setting disables origin validation and should only be used for local development.

## Production

Build and run:

```bash
npm run build
npm start
```

## Testing

### 1. Get OAuth2 Token from Docebo

```bash
curl -X POST "https://your-tenant.docebosaas.com/oauth2/token" \
  -d "grant_type=password" \
  -d "client_id=your_oauth_client_id" \
  -d "client_secret=your_oauth_client_secret" \
  -d "username=admin" \
  -d "password=your_password" \
  -d "scope=api"
```

### 2. Test Docebo API with Token

```bash
TOKEN="<access_token_from_step_1>"

curl -H "Authorization: Bearer $TOKEN" \
  "https://your-tenant.docebosaas.com/manage/v1/user?page_size=5"
```

### 3. Test MCP Server Health

```bash
curl http://localhost:3000/health
```

### 4. Test MCP Endpoint with Bearer Token

```bash
TOKEN="<access_token_from_step_1>"

# Initialize
curl -X POST http://localhost:3000/mcp \
  -H "Content-Type: application/json" \
  -H "Origin: https://claude.ai" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2025-03-26",
      "clientInfo": {
        "name": "test-client",
        "version": "1.0.0"
      }
    }
  }'

# List tools
curl -X POST http://localhost:3000/mcp \
  -H "Content-Type: application/json" \
  -H "Origin: https://claude.ai" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/list"
  }'

# Call tool
curl -X POST http://localhost:3000/mcp \
  -H "Content-Type: application/json" \
  -H "Origin: https://claude.ai" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "tools/call",
    "params": {
      "name": "docebo.list_users",
      "arguments": {
        "page": 1,
        "page_size": 5
      }
    }
  }'
```

## API Reference

### MCP Tool: docebo.list_users

Lists users from Docebo LMS with optional filtering and pagination.

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `page` | number | Page number (1-indexed) |
| `page_size` | number | Users per page (default: 200, max: 200) |
| `sort_attr` | string | Sort attribute (e.g., "user_id", "username") |
| `sort_dir` | string | Sort direction: "asc" or "desc" |
| `search_text` | string | Search filter for username or email |

**Example:**

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "docebo.list_users",
    "arguments": {
      "page": 1,
      "page_size": 10,
      "search_text": "john"
    }
  }
}
```

## Security

- **HTTPS Required**: Always use HTTPS in production
- **API Key Protection**: Keep `MCP_API_KEY` secret
- **Origin Validation**: Only whitelisted origins are allowed
- **Token Caching**: OAuth tokens are cached in memory with auto-refresh
- **No Logging of Secrets**: Tokens and keys are never logged

## Architecture

```
┌─────────────────┐
│  MCP Client     │ (Claude.ai, ChatGPT, etc.)
│  (Browser)      │
└────────┬────────┘
         │ HTTPS + API Key
         │
┌────────▼────────┐
│  Express Server │
│  - Origin Check │
│  - API Key Auth │
└────────┬────────┘
         │
┌────────▼────────┐
│  MCP Handler    │
│  (JSON-RPC)     │
└────────┬────────┘
         │
┌────────▼────────┐
│  OAuth Manager  │
│  (Token Cache)  │
└────────┬────────┘
         │
┌────────▼────────┐
│  Docebo API     │
│  /manage/v1/*   │
└─────────────────┘
```

## Project Structure

```
dcbo-mcp-server/
├── src/
│   ├── config.ts       # Environment validation
│   ├── oauth.ts        # Token management
│   ├── docebo.ts       # Docebo API client
│   ├── mcp.ts          # JSON-RPC handler
│   └── server.ts       # Express app
├── .env.example
├── package.json
├── tsconfig.json
└── README.md
```

## License

MIT
